# dPay Documentation
> This documentation is a work in progress and only gets better with each update.

## Getting Started
### Initial Setup
- Ensure you have installed Node.js v8+ & NPM with the command `node -v; npm -v`
- Download/clone this repository and `cd` to it.
- `npm run setup` to register current directory as dPay installation (may require elevated privileges depending on Node.js installation).

### dPay CLI
The dPay CLI simpliflies controlling the dPay daemon.
After successful setup, you may use the CLI from anywhere with command `dpay`. Unless you've manually created a configuration file, you'll need to run `dpay configure` to generate one for you. This will auto-generate and configure a `config.json` file in the installation directory with passphrases and mnemonics as well as the dPay installation ID.

## Configuring dPay
dPay's configuration is JSON-based. The `config.json` file is how you configure dPay. dPay's CLI tool will auto-generate some configuration for you when you run `dpay configure`. It is paramount to backup the sensitive values in `config.json` before proceeding to run dPay.

## Running dPay
You may proceed to start the dPay daemon with `dpay start`.

The following are basic dPay CLI commands for controlling the dPay daemon:
- `dpay start`: Starts dPay daemon.
- `dpay reload`: Safely restarts dPay daemon (useful when you've changed configuration or updated dPay).
- `dpay stop`: Safely stops dPay daemon.

## API

### HTTP API
A RESTful JSON-based interface that can be invoked with any regular HTTP request library/tool. Note that dPay allows to adjust or disable timeout on the underlying connection socket to favour operations that span long intervals, so it's up to you to configure your HTTP client to not timeout on dPay's endpoints and configure dPay to not timeout on lengthy requests.

All endpoints return the following payload structure:

```
{
  "request": string -> the original request URI,
  "error": null || {
    "message": null || string -> error message,
    "code": null || number -> error code,
    "name": null || string -> error name
  },
  "result": null || object -> result of the operation
}
```

All responses are delivered with HTTP success status `200` regardless of error occurence. You must explicitly check if the error placeholder in the payload is an object (signifying occurence of an error) or null (depicting absence of error).

All endpoints must be constructed as `/<app name>/<operation>/<asset core>`, where `<app name>` is an app you've defined in dPay's configuration, `<operation>` is a supported dPay operation and `<asset core>` is a supported asset core in dPay.

For example, a `POST` request to `http://localhost:8700/mycryptomall/ping/bitcoin` with supported parameters would return a payload as described in [ping](./API/HTTP/ping.md).

All requests must carry a `X-dPay-Signature` header. This is HMAC signature obtained by hashing the request payload with the app secret that corresponds to the request `<app name>` param. This is used to verify the integrity and authenticity of the request, to ensure that only your configured apps can access dPay's endpoints. With Node.js, you could do the following:

  ```javascript
  const fetch = require('node-fetch')
  const CryptoJS = require('crypto-js')

  const payload = JSON.stringify({
    meta: {
      type: 'p2sh-segwit'
    }
  })

  const hash = CryptoJS.HmacSHA1(
    payload,
    pm.environment.get('<app secret as configured in dPay>')
  ).toString(CryptoJS.enc.Hex)
  

  fetch('http://localhost:8700/mycryptomall/get-deposit-address/bitcoin', {
      method: 'post',
      body: payload,
      headers: {
        'Content-Type': 'application/json',
        'X-dPay-Signature': `sha1=${hash}`
      },
  })
    .then(res => res.json())
    .then(json => console.log(json))
  ```
<br />

#### Asset cores:
- bitcoin -> Bitcoin
- ethereum -> Ether and Ethereum-based assets

#### Operations:
- [ping](./API/HTTP/ping.md) -> Probe the connected RPC provider. Returns metadata like current block height and sync status.
- [get-deposit-address](./API/HTTP/get-deposit-address.md) -> Get a deposit address that can be assigned to a user in your app.
- [withdraw](./API/HTTP/withdraw.md) -> Submit withdrawal requests (with the defined main wallet as benefactor, where applicable).
- [query-transaction](./API/HTTP/query-transaction.md) -> Get transaction status, confirmation count, etc.
- [query-balance](./API/HTTP/query-balance.md) -> Get the balance of a specific wallet or summation of all wallets mapped to app.

## Miscellaneous
- [Setup Bitcoin Core on AWS EC2](./guides/Setup%20Bitcoin%20Core%20on%20AWS%20EC2.md)
- [Setup Parity Ethereum on AWS EC2](./guides/Setup%20Parity%20Ethereum%20on%20AWS%20EC2.md)

## Notes
### Safety
- Be sure to backup any passhprases, mnemonics, etc. that are auto-generated by dPay as there's no other way to recover them if lost.
### Security
- Despite inbuilt HMAC verification, you should setup firewall rules to grant access to dPay to only designated apps.
- If dPay is to be accessed outside localhost, you most definitely should put it behind a TLS-enabled proxy.
